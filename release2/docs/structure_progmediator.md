# Structure of the mediator: principal
Program mediators is used for management operation specific to program. Every program will have its dedicated mediators. The following operations are performed for each programs
* Generate the metadata (dataElements) related to the requisition information of the products in DHIS2.The requisition concerns the data on the inventory of the products such as the quantity received, the stock on hand, the losses. For optimizing the metadata each program, the requisitions data elements are generated by program using the prefix of product code in the data element name.
* Extract requisitions data in eLMIS and save them in Hapi server.
* Push requisitions data from HAPI to DHIS2 as ADX resources.
* Generate the indicators (supply chain indicators) from HAPI and push them to DHIS2. This is done because of the complexity of calculating some indicators directly in DHIS2 using the requisition's data and hard coded formula .

## Configuration
The file structure of the mediator-principal is represented below. The last release of the source code is located the 'release2' folder. After cloning the repository from git hub go in the release2 folder.
```
git clone https://github.com/gerard-bisama/guinea-interop-dhis2-esigl.git
cd guinea-interop-dhis2-esigl/release2
```
The file structure looks like this:
```
cd /
release2
|_ mediator-principal  
  |_ Dockerfile
  |_ env.list
  |_ src
    |_config
      |_ config.json
      |_ dhismetadata.json
      |_ mediator.json  
    |_ data
      |_ logs
    |_ lib
    |_ package.json

```
* mediator-PNLP: the main folder that contains the mediator source codes, it can be use as the starting point for all other programs.
* Dockerfile: Set of instructions which are used by docker build for building a custom docker image of the mediator-principal
* env.list: used to set environment variable for the mediator-principal docker
* data/logs: contains the logs of the app 
* src: contains the config, lib, data folder.
* lib: the librairy of the source code of the micro-service
* config: the configuration files

### Configuration of the type of the service
This section show how to configure a mediator as a standalone microservice or an openHIM components
```
$ cd mediator-principal/src/config
$ nano config.json
```
Here is the contains

```
{
  "api": {
    "username": "root@openhim.org",
    "password": "password", 
    "apiURL": "https://localhost:8080",
    "trustSelfSigned": "true"
  },
  "register": false,
  "heartbeat": true
}

```
here are the parameter to set (lease the other as they are)
* password: the password of the root openhim user as set during the installation of the openHIM
* register: false|true. false to run the mediator as a standalone component and true to register the mediator in openHIM. If true the mediator should appear in the Admin console of openHIM.

### Configuration of mediator 
The mediator needs to interact with eLMIS and DHIS2 to extract data, transform them on a standard format based on the needs and then exchange them. The HAPI FHIR server is used as a central repository for sharing the data extracted and processed from both system's as resources that can be used by an other system which make the solution able to be scalled up on new usecase. The mediator play this role by implementing the business logics related to Extraction, Transformation and Loading (ETL) of data.
To edit the mediator
 ```
$ cd mediator-principal/src/config
$ nano mediator.json
```

Leave other node as they are and configure the value in the 'config' node.
To learn more about the skeleton of mediators and configuration file, visit the [OpenHIM dev guide](https://openhim.org/docs/dev-guide/developing-mediators).

```JSON
{
  "urn": "urn:uuid:a4976a30-9364-11e9-9146-07d60medpg01",
  "version": "0.3.1",
  "name": "Mediateur PNLP",
  "description": "Extraction des donnees sur les requisitions de eSIGL->DHIS2",
  "defaultChannelConfig": [],
  ....
  "config": {
    "dhis2Server":{
		"url":"https://localhost/api",
		"username":"user",
		"password":"pwd"
		},
	"hapiServer":{
    "url":"http://localhost/fhir",
    "username":"",
		"password":""
		},
	"esiglServer":{
		"url":"https://localhost",
		"username":"user",
		"password":"pwd",
		"resourcespath":"/rest-api"
    },
  "elasticsearchServer":{
      "url":"http://localhost:9200",
      "username":"",
      "password":""
    },
  "extensionBaseUrlRequisitionDetails":"https://www.hl7.org/fhir/StructureDefinition/requisitionDetail",
  "extensionBaseUrlProgramDetails":"https://www.hl7.org/fhir/StructureDefinition/ProgramDetails",
  "program":{
    "name":"pnlp0",
    "code":"SIGL-INTEGRE-PNLP"
  },
  "synchronizationPeriod":"2024-11",
  "maxNbRequisitions2PullPerLoop":"20",
  "zoneGeographiqueId":"odY5MzWb1jc",
  "extractionPeriodId":"144",
  "skipNiveauPS":"true",
  "productToSkipForSyncInDHS2":["TMP0122","TMP0123","TMP0120","TMP0121","TMP0124"],
  "dhis2ResponseVersion":"2.37"
}
```
* urn,version,name,description: elements of identification of the mediators. 
* logstashDirectory,elasticsearchServer:(!!! deprecated) they were used for visualizing logs. Now this can been done with [portainer](https://docs.portainer.io/start/install-ce/server/docker/linux). Don't worry about them.
* dhis2Server: url endpoint of DHIS2 and associated credentials. Since the associated  account should be able to create/update DHIS2 metadata related to category (CategoryOption,Category,CategoryCombo,categoryOptionCombo).
* esiglServer:  url endpoint of eLMIS and associated credentials. The associated  account should be able to read facilities, products and programs informations.
*  extensionBaseUrlRequisitionDetails and extensionBaseUrlProgramDetails: information about profile related to Requisitions and products. Don't change any thing.
* program.code: used to specify which program to use to extract products informations in DHIS2 used in the generation/update of dataElements catCombos. It is also used to filter requisitions extracted from eLMIS to push to FHIR repository and to extract from FHIR repository and to push in DHIS2 in ADX format. 
* program.name: used to specify define the prefix of data elemenent generated as define in the config file dhismetadatadef.json.
* synchronizationPeriod: periods used to extract requisition for FHIR repository and to push them in DHIS2
* maxNbRequisitions2PullPerLoop: the max number of requisition to pull from FHIR in the sync to DHIS2 operation.
* zoneGeographiqueId: used to define the region (parent) from which all facility children will be used to extract requisition from eLMIS and to push in FHIR repository. Used to avoid timeout on the eLMIS side. Used also will extracting requisition from FHIR repository to push in DHIS2 and when generating dataElement for the DHIS2 dashboard indicators.
* extractionPeriodId:  periods used to extract requisition for eLMIS  and to push them in FHIR repository
* skipNiveauPS: by default leave to 'true' to skip the level orgUnit of level : health post|service, since they dont submit logistic|inventory data. Instead their data are agregated under the Health Center who manage them.
* productToSkipForSyncInDHS2: Products to skip when pushing inventory data into DHIS2 or generate dataElements for the dashboard.
* dhis2ResponseVersion: ability to adapt handle the DHIS2 ADX push response based on the DHIS2 version. The response may changed based on the version.


### Configuration of env variable for the docker
When running as docker container, the mediator will need to read some environment variable.
Here is the content of the env.list file.

```
OPENHIM_APIURL=https://localhost:8083
OPENHIM_USERNAME=admin
OPENHIM_PASSWORD=admin
OPENHIM_TRUSTSELFSIGNED=true
MEDIATOR_HOST=localhost
MEDIATOR_PORT=5022
MEDIATOR_REGISTER=true
MEDIATOR_HEARTBEAT=true
MEDIATOR_CHANNELIDENTIFIER=PNLP
MEDIATOR_CONFIG_PROGRAMNAME=pnlp0
MEDIATOR_CONFIG_PROGRAMCODE=SIGL-INTEGRE-PNLP
MEDIATOR_URN=urn:uuid:a4976a30-9364-11e9-9146-07d60medpg02
MEDIATOR_NAME=Mediateur pnlp
```
here are the parameter to set (lease the other as they are).
* OPENHIM_APIURL: replace IP by the local IP of the computer were the openHIM core is installed
* OPENHIM_PASSWORD: the password of the root@oepnhim.org
* MEDIATOR_HOST: replace IP by the local IP of the computer where the mediator is running.
* MEDIATOR_PORT: define the port of the mediator
* MEDIATOR_REGISTER: false|true. false to run the mediator as a standalone component and true to register the mediator in openHIM. If true the mediator should appear in the Admin console of openHIM.
* MEDIATOR_CONFIG_PROGRAMNAME: The mediator name that will apper in '[]' of the channel's manes in openHIM console
* MEDIATOR_CONFIG_PROGRAMNAME: same as mediator config variable program.name
* MEDIATOR_CONFIG_PROGRAMCODE: same as mediator config variable program.code
* MEDIATOR_URN : same as mediator config variable urn
* MEDIATOR_NAME: name of mediator 

### Configuration of data elements metadata
The file _dhismetadatadef.json_ define content the list of data elements to create in DHIS2 to record requisition's data and dashboard data.

```JSON
{
    "dataElements":[
        {
            "id":"100001",
            "name": "Quantité Utilisée",
			      "displayName": "Quantité utilisée",
            "disagragetedByProduct":"true"
        },
        {
            "id":"100002",
            "name": "Stock initial",
			      "displayName": "Stock initial",
            "disagragetedByProduct":"true"
        },
        ...
        {
            "id":"100016",
            "name": "Nombre pertes",
			      "displayName": "Nombre pertes",
            "disagragetedByProduct":"true"
        }
    ]
}
```
The element of the node represent the data element of DHIS2 and the attribute represent the element below:
* id: the dhis2 id of the data element. their concatenated with the program.name in the format _'programe.name+id'_ to defined at least 11 characters as required in DHIS2
* name: the name of the data element. It is generated by program with the pattern  _'SIGL-[ProgramCode][name]_ . The 'SIGL' prefix is hardcoded, the 'ProgramCode' is extracted from ProgramCode[2].
displayName: Display name of the data element
disagragetedByProduct: true|false where to use product as CatComboCombinaision for the dataElement.
